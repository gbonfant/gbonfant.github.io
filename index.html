
<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <title>Gus Bonfant</title>
  <meta name="author" content="Gus Bonfant">
  <meta name="description" content="">

  

  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  
  <link rel="canonical" href="http://www.gbonfant.com">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Gus Bonfant" type="application/atom+xml">
  <link href="//fonts.googleapis.com/css?family=Lato&subset=latin-ext" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=Cardo&subset=latin-ext" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-52415972-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'stats.g.doubleclick.net/dc.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body >
  <header role="banner"><hgroup>
  <h1><a href="/">Gus Bonfant</a></h1>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/about">About</a></li>
</ul>

<br>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/speed-up-performance-of-iterm-and-vim/">Speed up performance of iTerm and Vim</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-07-16T15:06:30+02:00" pubdate data-updated="true">Jul 16<sup>th</sup>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Over a year ago I switched to iTerm2 after several years of happily using Terminal.app on Mac OS X, and although I&rsquo;m more than happy with the change I&rsquo;ve noticed that in the last weeks the overall responsiveness of my terminal has declined. Initially I thought zsh and particularly <a href="https://github.com/robbyrussell/oh-my-zsh">oh-my-zsh</a> were at fault, and thus I switched to <a href="http://fishshell.com">fish</a>, my shell was definitely faster, and after getting used to the non POSIX world of fish I even became more productive. However, it didn&rsquo;t actually solve the issues with the terminal itself, and after moving my Vim environment to the shell I experienced horrible delays in the rendering response and startup of iTerm.</p>

<h2>How I solved it.</h2>

<p>First of all I tackled the slow starting time on iTerm, OS X keeps system logs in <code>/var/log/asl</code> and although great after years of usage they just end up piling up, so I just cleared them:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo rm /var/log/asl/*.asl
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>It&rsquo;s important that you don&rsquo;t remove all the files in the asl directory as they also host other files unrelated to the shell.</p></blockquote>

<p>Secondly I changed the startup shell from its default value to <code>/usr/local/bin/fish -l</code>, this can be done under Profiles > General > Command in iTerm 2 and the value you need to add will depend on which shell you are using and where in your filesystem it is located, for instance you might want to set it up to <code>/bin/bash -l</code> if you are using bash.</p>

<p><img src="/images/speed_up_iterm.png" title="'Configuration window for iTerm2'" ></p>

<p>This improved the overall snappiness of iTerm2 but I still had an issue with the rendering performance of Vim.</p>

<h2>Making Vim buttery smooth</h2>

<p>This was an easy one, MacVim is fast, why Vim isn&rsquo;t? I still haven&rsquo;t found an answer to this question but I had no intention of going back to running Vim on a separate GUI shell, fortunately you can use MacVim as a CLI by appending the flag <code>-v</code> then simply alias it to vim, for fish that would be:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="k">function </span>vim
</span><span class='line'>  mvim -v <span class="nv">$argv</span>
</span><span class='line'>end
</span></code></pre></td></tr></table></div></figure>


<p>Now your iTerm should be faster and Vim rendering smoother.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/responding-to-scope-changes-with-controller-as-syntax/">Responding to scope changes with controller as syntax</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-07-11T14:51:50+02:00" pubdate data-updated="true">Jul 11<sup>th</sup>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Before AngularJS 1.2 we used to bind our data models to the <code>$scope</code> object in a controller. I find this confusing as the use  of <code>scope</code> across my angular code looked like some dark magic.</p>

<p>Starting on <a href="https://github.com/angular/angular.js/blob/master/CHANGELOG.md#115-triangle-squarification-2013-05-22">1.1.5</a> the <em>controller as</em> syntax was introduced, this allowed us to declare our controllers as plain javascript objects, such as:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">myApp</span><span class="p">.</span><span class="nx">controller</span><span class="p">(</span><span class="s1">&#39;PersonController&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="s1">&#39;James&#39;</span><span class="p">;</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>I liked this approach but it introduced an annoyance: watching scope changes didn&rsquo;t work anymore.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">myApp</span><span class="p">.</span><span class="nx">controller</span><span class="p">(</span><span class="s1">&#39;PersonController&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;$scope&#39;</span><span class="p">,</span> <span class="s1">&#39;NotificationFactory&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">$scope</span><span class="p">,</span> <span class="nx">NotificationFactory</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">this</span><span class="p">.</span><span class="nx">name</span>          <span class="o">=</span> <span class="s1">&#39;James&#39;</span><span class="p">;</span>
</span><span class='line'>  <span class="k">this</span><span class="p">.</span><span class="nx">notifications</span> <span class="o">=</span> <span class="nx">NotificationFactory</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">$scope</span><span class="p">.</span><span class="nx">watch</span><span class="p">(</span><span class="s1">&#39;notifications&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">newValue</span><span class="p">,</span> <span class="nx">oldValue</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;This does not work&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">}]);</span>
</span></code></pre></td></tr></table></div></figure>


<p>After digging in angular&rsquo;s still confusing and terse <a href="https://docs.angularjs.org/api/ng/type/$rootScope.Scope">documentation</a> I realised that you can pass a function as a listener argument to <code>$watch</code>, meaning that after properly binding our current context we could watch on our controller&rsquo;s object like so:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">myApp</span><span class="p">.</span><span class="nx">controller</span><span class="p">(</span><span class="s1">&#39;PersonController&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;$scope&#39;</span><span class="p">,</span> <span class="s1">&#39;NotificationFactory&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">$scope</span><span class="p">,</span> <span class="nx">NotificationFactory</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">this</span><span class="p">.</span><span class="nx">name</span>          <span class="o">=</span> <span class="s1">&#39;James&#39;</span><span class="p">;</span>
</span><span class='line'>  <span class="k">this</span><span class="p">.</span><span class="nx">notifications</span> <span class="o">=</span> <span class="nx">NotificationFactory</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">$scope</span><span class="p">.</span><span class="nx">watch</span><span class="p">(</span><span class="nx">angular</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">notifications</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}),</span> <span class="kd">function</span><span class="p">(</span><span class="nx">newValue</span><span class="p">,</span> <span class="nx">oldValue</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// This does work!</span>
</span><span class='line'>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">newValue</span><span class="p">,</span> <span class="nx">oldValue</span><span class="p">);</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">}]);</span>
</span></code></pre></td></tr></table></div></figure>


<p>Although this approach works it does not look elegant enough for such a behemoth of a framework. The amount of <a href="https://github.com/allaud/quick-ng-repeat">hacks</a> and <a href="http://stackoverflow.com/questions/15666048/angular-js-service-vs-provider-vs-factory">patterns</a> you sometimes need to apply in order to accomplish a relatively simple task is making me reconsidering angular in favour of more elegant and more performant <a href="http://facebook.github.io/react/">alternatives</a>.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/execute-function-on-ng-repeat-done/">Execute a function on ng-repeat done</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-08-25T21:58:05+02:00" pubdate data-updated="true">Aug 25<sup>th</sup>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>ngRepeat is one of Angular&rsquo;s most powerful directives and in most cases <em>it just works</em>, however there are times when I find myself wanting to update the DOM or execute a function as soon as the directive has finished its job.</p>

<p>Thanks to Angular&rsquo;s <a href="http://docs.angularjs.org/api/ng.$rootScope.Scope#$destroy">$destroy()</a> I can create a custom directive to accomplish such effect.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">angular</span><span class="p">.</span><span class="nx">module</span><span class="p">(</span><span class="s1">&#39;app&#39;</span><span class="p">,</span> <span class="p">[]);</span>
</span><span class='line'>
</span><span class='line'><span class="nx">app</span><span class="p">.</span><span class="nx">directive</span><span class="p">(</span><span class="s1">&#39;repeatDone&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">scope</span><span class="p">,</span> <span class="nx">element</span><span class="p">,</span> <span class="nx">attrs</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">element</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="s1">&#39;$destroy&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="nx">scope</span><span class="p">.</span><span class="nx">$last</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">scope</span><span class="p">.</span><span class="nx">$eval</span><span class="p">(</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">repeatDone</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>By simply calling our directive along with <code>ng-repeat</code> we can then execute our function as soon as the iteration is finished.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;div</span> <span class="na">ng-repeat=</span><span class="s">&quot;item in model.items&quot;</span> <span class="na">repeat-done=</span><span class="s">&quot;foo()&quot;</span><span class="nt">&gt;&lt;/div&gt;</span>
</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/set-up-log-level-specific-exceptions/">Set-up log level for specific exceptions</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-08-19T21:08:49+02:00" pubdate data-updated="true">Aug 19<sup>th</sup>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>It seems to me that in the Rails world logging is an afterthought, something that can be easily taken care of via 3rd party services, not surprising considering how inexpensive, robust and easy to setup they are.</p>

<p>However, if you are manually keeping track of your logs with something like <a href="http://graylog2.org">graylog</a> finding any useful, straightforward information about logging in Rails can be daunting. So without any straightforward answer as to how to set a warn level for all those pesky 404 errors that were polluting our logs I decided to peek into Rails&#8217; internals. <a href="http://api.rubyonrails.org/classes/ActionDispatch/DebugExceptions.html">ActionDispatch::DebugExceptions</a> is a simple piece of middleware in charge of logging exceptions, upon further inspection I stumbled upon <code>log_error</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">log_error</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">wrapper</span><span class="p">)</span>
</span><span class='line'>  <span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="k">unless</span> <span class="n">logger</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">exception</span> <span class="o">=</span> <span class="n">wrapper</span><span class="o">.</span><span class="n">exception</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">trace</span> <span class="o">=</span> <span class="n">wrapper</span><span class="o">.</span><span class="n">application_trace</span>
</span><span class='line'>  <span class="n">trace</span> <span class="o">=</span> <span class="n">wrapper</span><span class="o">.</span><span class="n">framework_trace</span> <span class="k">if</span> <span class="n">trace</span><span class="o">.</span><span class="n">empty?</span>
</span><span class='line'>
</span><span class='line'>  <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Deprecation</span><span class="o">.</span><span class="n">silence</span> <span class="k">do</span>
</span><span class='line'>    <span class="c1"># string manipulation code ...</span>
</span><span class='line'>    <span class="n">logger</span><span class="o">.</span><span class="n">fatal</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">message</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>It looks like <code>log_error</code> is logging every exception as fatal, this is exactly the behaviour I want to modify.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">ActionDispatch</span><span class="o">::</span><span class="no">DebugExceptions</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">log_error</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">wrapper</span><span class="p">)</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">if</span> <span class="n">wrapper</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">is_a?</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">RoutingError</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">super</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>I could as well override the method and add my own logic to it, for instance if I wanted to add a conditional, like so:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">log_error</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">wrapper</span><span class="p">)</span>
</span><span class='line'>  <span class="c1"># ...</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">exception</span><span class="o">.</span><span class="n">is_a?</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">RoutingError</span>
</span><span class='line'>    <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">message</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>    <span class="n">logger</span><span class="o">.</span><span class="n">fatal</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">message</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'> <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Middleware code is a joy to read and a great reminder that our code should be simple, lean and understandable.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/deleting-nested-hashes-in-ruby/">Deleting nested hashes in Ruby</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-06-26T20:16:31+02:00" pubdate data-updated="true">Jun 26<sup>th</sup>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I wanted to expose a method for performing a relatively common problem I was facing: removing nested items in a data structure. I tried to aproach the problem by naively duplicating the object and deleting any nested hash.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Hash</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">except_nested_key</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span><span class='line'>    <span class="nb">dup</span><span class="o">.</span><span class="n">except_nested_key!</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">except_nested_key!</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span><span class='line'>    <span class="n">each</span> <span class="p">{</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="n">v</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">is_a?</span> <span class="no">Hash</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nb">self</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>This implementation exposes a few flaws. To begin with, both <code>dup</code> and <code>clone</code> make shallow copies of the given object, which means our nested hashes are just references to the original object, because of this, unless the nested hashes in the original object were frozen both methods will mutate the original object state! <sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup></p>

<p>Fortunately we can achieve a deep copy of our original object and preserve its integrity using <a href="http://ruby-doc.org/core-1.9.3/Marshal.html">Marshal</a>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Hash</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">except_nested_key</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span><span class='line'>    <span class="n">copy</span> <span class="o">=</span> <span class="no">Marshal</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="no">Marshal</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="nb">self</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">copy</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span><span class="o">|</span> <span class="n">v</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">is_a?</span> <span class="no">Hash</span> <span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>



<div class="footnotes">
<hr/>
<ol>
<li id="fn:1">
<p><em>Object-oriented programming makes code understandable by encapsulating moving parts. Functional programming makes code understandable by minimizing moving parts.</em> — Michael Feathers<a href="#fnref:1" rev="footnote">&#8617;</a></p></li>
</ol>
</div>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/assigning-date-attributes-without-active-record/">Assigning date attributes without ActiveRecord</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-05-14T16:13:26+02:00" pubdate data-updated="true">May 14<sup>th</sup>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>When straying away from &ldquo;the rails path&rdquo; we may find ourselves missing some nifty functionality the Rails modules provide us.</p>

<p>The most ubiquitous of those, ActiveRecord, is without a doubt a behemont of nifty functionalities, in this case seemingly instantiating and assigning date object to our models date attributes is a feature we give for granted.</p>

<p>However, if you are building Rails applications without ActiveRecord you might find yourself in a predicament when submitting a form with dates.</p>

<p>Assuming the following class:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Person</span> <span class="o">&lt;</span> <span class="no">BaseModel</span>
</span><span class='line'>  <span class="c1"># For the sake of simplicity, BaseModel will add all the boilerplate</span>
</span><span class='line'>  <span class="c1"># needed for making our class behave like an AR model class.</span>
</span><span class='line'>  <span class="kp">attr_accessor</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:birth_date</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">attributes</span> <span class="o">=</span> <span class="kp">nil</span><span class="p">)</span>
</span><span class='line'>    <span class="k">super</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>When submitting a form with the following parameters, <code>name</code> will be automatically assigned but <code>birth_date</code> won&rsquo;t.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;James Bond&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="s2">&quot;birth_date(3i)&quot;</span><span class="o">:</span> <span class="s2">&quot;11&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="s2">&quot;birth_date(2i)&quot;</span><span class="o">:</span> <span class="s2">&quot;11&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="s2">&quot;birth_date(1i)&quot;</span><span class="o">:</span> <span class="s2">&quot;1920&quot;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The reason is simple, neither of the remaining parameters are attributes of our class. On ActiveRecord land, however, the remaining parameters will magically be assigned to our class attribute due to <code>assign_attribute</code> method call, which automatically assigns multi parameter attributes. This works by iterating over the passed attributes, selecting those that are of the type multi parameter, extract their values and assign them to a new hash which will ultimately be assigned to the parent class.</p>

<p>By poking into ActiveRecord&rsquo;s internals we can extract this logic into our own method:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Person</span> <span class="o">&lt;</span> <span class="no">BaseModel</span>
</span><span class='line'>  <span class="kp">attr_accessor</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:birth_date</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">attributes</span> <span class="o">=</span> <span class="kp">nil</span><span class="p">)</span>
</span><span class='line'>    <span class="k">super</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">assign_dates</span><span class="p">(</span><span class="n">attributes</span><span class="p">)</span> <span class="k">if</span> <span class="n">attributes</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">protected</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">assign_dates</span><span class="p">(</span><span class="n">attributes</span><span class="p">)</span>
</span><span class='line'>    <span class="n">new_attributes</span>            <span class="o">=</span> <span class="n">attributes</span><span class="o">.</span><span class="n">stringify_keys</span>
</span><span class='line'>    <span class="n">multiparameter_attributes</span> <span class="o">=</span> <span class="n">extract_multiparameter_attributes</span><span class="p">(</span><span class="n">new_attributes</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">multiparameter_attributes</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">multiparameter_attribute</span><span class="p">,</span> <span class="n">values_hash</span><span class="o">|</span>
</span><span class='line'>      <span class="n">set_values</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">.</span><span class="n">.</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">{</span> <span class="o">|</span><span class="n">position</span><span class="o">|</span> <span class="n">values_hash</span><span class="o">[</span><span class="n">position</span><span class="o">].</span><span class="n">to_i</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="nb">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">multiparameter_attribute</span><span class="si">}</span><span class="s2">=&quot;</span><span class="p">,</span> <span class="no">Date</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">*</span><span class="n">set_values</span><span class="p">))</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">extract_multiparameter_attributes</span><span class="p">(</span><span class="n">new_attributes</span><span class="p">)</span>
</span><span class='line'>    <span class="n">multiparameter_attributes</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">new_attributes</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="o">|</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">)</span>
</span><span class='line'>        <span class="n">multiparameter_attributes</span> <span class="o">&lt;&lt;</span> <span class="o">[</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="o">]</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">extract_attributes</span><span class="p">(</span><span class="n">multiparameter_attributes</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">extract_attributes</span><span class="p">(</span><span class="n">pairs</span><span class="p">)</span>
</span><span class='line'>    <span class="n">attributes</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">pairs</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">pair</span><span class="o">|</span>
</span><span class='line'>      <span class="n">multiparameter_name</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">pair</span>
</span><span class='line'>      <span class="n">attribute_name</span>             <span class="o">=</span> <span class="n">multiparameter_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span>
</span><span class='line'>      <span class="n">attributes</span><span class="o">[</span><span class="n">attribute_name</span><span class="o">]</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">unless</span> <span class="n">attributes</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="n">attribute_name</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">attributes</span><span class="o">[</span><span class="n">attribute_name</span><span class="o">][</span><span class="n">find_parameter_position</span><span class="p">(</span><span class="n">multiparameter_name</span><span class="p">)</span><span class="o">]</span> <span class="o">||=</span> <span class="n">value</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">attributes</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">find_parameter_position</span><span class="p">(</span><span class="n">multiparameter_name</span><span class="p">)</span>
</span><span class='line'>    <span class="n">multiparameter_name</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="sr">/\(([0-9]*).*\)/</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">to_i</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Diving into ActiveRecord&rsquo;s source is a rewarding exercise that greatly helps to understand the &ldquo;magic&rdquo; behind Rails nifty features.</p>

<p><em>Update:</em> It looks like this functionality will get extracted into ActiveModel for use by non-AR classes in 4.2 – <a href="https://github.com/rails/rails/pull/8189">https://github.com/rails/rails/pull/8189</a></p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Gus Bonfant |
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>.
</p>

</footer>
  











</body>
</html>
